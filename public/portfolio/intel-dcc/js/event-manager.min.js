!function(){"use strict";IntelDCC.api={},IntelDCC.api.event=null,IntelDCC.eventManager={alertsUpdated:!1,usersUpdated:!1,eventID:null},$(document).ready(function(){IntelDCC.eventManager.eventID=IntelDCC.getParameterByName("event-id"),IntelDCC.eventManager.eventListeners(),IntelDCC.eventManager.eventID&&IntelDCC.eventManager.downloadData(),IntelDCC.eventManager.resetAlertDropdowns(),IntelDCC.eventManager.resetUsersDropdowns()}),IntelDCC.eventManager.eventListeners=function(){$("#alerts-list").on("click","[data-delete-alert-button]",function(){IntelDCC.eventManager.deleteAlertListing(this)}),$("#user-list").on("click","[data-delete-user-button]",function(){IntelDCC.eventManager.deleteUserListing(this)}),$("#add-alert-button").on("click",function(){IntelDCC.eventManager.openAlertsDropdown()}),$("#cancel-add-alert-button").on("click",function(){IntelDCC.eventManager.closeAlertsDropdown()}),$("#confirm-add-alert-button").on("click",function(){IntelDCC.eventManager.confirmNewAlert()}),$("#add-user-button").on("click",function(){IntelDCC.eventManager.openUsersDropdown()}),$("#cancel-add-user-button").on("click",function(){IntelDCC.eventManager.closeUsersDropdown()}),$("#confirm-add-user-button").on("click",function(){IntelDCC.eventManager.confirmNewUser()}),$("#save-event-button").on("click",function(){IntelDCC.eventManager.saveEvent()})},IntelDCC.eventManager.downloadData=function(){$("#intel-api-loading-icon").show();var e=new Promise(function(e,n){$.post("api/get-event-settings.php",{eventID:IntelDCC.eventManager.eventID},function(n){n.hasOwnProperty("id")?(IntelDCC.api.event=n,e(IntelDCC.api.event)):(IntelDCC.eventManager.eventID=null,$("#intel-api-loading-icon").hide(),$("#main-section-heading").text("New Event"))})});e.then(function(e){$("#event-name").val(e.eventName),$("#event-comment").val(e.eventComment),$("#event-type").val(e.eventType),IntelDCC.api.event.alerts.forEach(function(e){IntelDCC.eventManager.addAlertListing(e.groupId,e.deviceId,e.displayName,e.sensorId,e.alertLevel)})}),e.then(function(){var e=new Promise(function(e,n){$.post("api/get-users.php",function(n){IntelDCC.api.users=n,e()})});e.then(function(){IntelDCC.api.event.users.forEach(function(e){IntelDCC.api.users.forEach(function(n){if(n.userId===e.userId){var t=n.firstName+" "+n.lastName;IntelDCC.eventManager.addUserListing(n.userId,t)}})}),$("#intel-api-loading-icon").hide()})})},IntelDCC.eventManager.openAlertsDropdown=function(){$("#add-alert-button").addClass("hidden"),$("#alerts-list-dropdowns").removeClass("hidden"),$("#cancel-add-alert-button").removeClass("hidden"),$("#confirm-add-alert-button").removeClass("hidden")},IntelDCC.eventManager.closeAlertsDropdown=function(){$("#add-alert-button").removeClass("hidden"),$("#alerts-list-dropdowns").addClass("hidden"),$("#cancel-add-alert-button").addClass("hidden"),$("#confirm-add-alert-button").addClass("hidden"),IntelDCC.eventManager.resetAlertDropdowns()},IntelDCC.eventManager.openUsersDropdown=function(){$("#add-user-button").addClass("hidden"),$("#user-list-dropdowns").removeClass("hidden"),$("#cancel-add-user-button").removeClass("hidden"),$("#confirm-add-user-button").removeClass("hidden")},IntelDCC.eventManager.closeUsersDropdown=function(){$("#add-user-button").removeClass("hidden"),$("#user-list-dropdowns").addClass("hidden"),$("#cancel-add-user-button").addClass("hidden"),$("#confirm-add-user-button").addClass("hidden"),IntelDCC.eventManager.resetUsersDropdowns()},IntelDCC.eventManager.resetAlertDropdowns=function(){IntelDCC.resetDropdown("#sensor-selector-groups",!1),IntelDCC.resetDropdown("#sensor-selector-devices",!0),IntelDCC.resetDropdown("#sensor-selector-sensors",!0),IntelDCC.resetDropdown("#sensor-selector-levels",!1)},IntelDCC.eventManager.resetUsersDropdowns=function(){IntelDCC.resetDropdown("#user-selector",!1)},IntelDCC.eventManager.confirmNewAlert=function(){var e=$("#alerts-list-dropdowns"),n=$("#sensor-selector-groups").val(),t=$("#sensor-selector-devices").val(),a=$("#sensor-selector-sensors").val(),r=$("#sensor-selector-levels").val();if(n&&t&&a&&r){var s=$("#sensor-selector-devices option:selected").text();IntelDCC.eventManager.alertsUpdated=!0,IntelDCC.eventManager.addAlertListing(n,t,s,a,r),IntelDCC.eventManager.closeAlertsDropdown()}else $(e).animateCSS("form-error")},IntelDCC.eventManager.confirmNewUser=function(){var e=$("#user-list-dropdowns"),n=$("#user-selector").val(),t=$("#user-selector :selected").text();n?(IntelDCC.eventManager.usersUpdated=!0,IntelDCC.eventManager.addUserListing(n,t),IntelDCC.eventManager.closeUsersDropdown()):$(e).animateCSS("form-error")},IntelDCC.eventManager.addAlertListing=function(e,n,t,a,r){var s=!1,o=$("#alerts-list");$(o).find("[data-event-alert]").each(function(t,o){var l=$(o).attr("data-group-id"),i=$(o).attr("data-device-id"),d=$(o).attr("data-sensor-id");if(l==e&&i==n&&d==a){var v=IntelDCC.getAlertLevelLabel(r);$(o).attr("data-alert-level",r),$(o).find("[data-alert-level-label]").text(v),s=!0}}),s===!1&&o.append('<div class="standard-list__item standard-list__item--flex" data-group-id="'+e+'" data-device-id="'+n+'" data-sensor-id="'+a+'" data-alert-level="'+r+'" data-event-alert><span>'+t+", "+a+" - <span data-alert-level-label>"+IntelDCC.getAlertLevelLabel(r)+'</span></span><input type="button" class="icon-button icon-button--close icon-button--no-margin" data-delete-alert-button></div>')},IntelDCC.eventManager.addUserListing=function(e,n){var t=!1,a=$("#user-list");$(a).find("[data-event-user]").each(function(n,a){var r=$(a).attr("data-user-id");r==e&&(t=!0)}),t===!1&&a.append('<div class="standard-list__item standard-list__item--flex" data-user-id="'+e+'" data-event-user><span>'+n+'</span><input type="button" class="icon-button icon-button--close icon-button--no-margin" data-delete-user-button></div>')},IntelDCC.eventManager.deleteAlertListing=function(e){IntelDCC.eventManager.alertsUpdated=!0,$(e).closest("[data-event-alert]").remove()},IntelDCC.eventManager.deleteUserListing=function(e){IntelDCC.eventManager.usersUpdated=!0,$(e).closest("[data-event-user]").remove()},IntelDCC.eventManager.saveEvent=function(){var e=$("#event-name").val().trim(),n=$("#event-comment").val().trim(),t=$("#event-type").val();if(IntelDCC.eventManager.closeAlertsDropdown(),IntelDCC.eventManager.closeUsersDropdown(),e&&n&&t){$("#intel-api-loading-icon").show();var a=$("#save-event-button");a.attr("disabled","disabled"),IntelDCC.eventManager.saveEventDetails(e,n,t)}else $("#event-settings").animateCSS("form-error")},IntelDCC.eventManager.saveEventDetails=function(e,n,t){$.post("api/set-event-setting.php",{eventID:IntelDCC.eventManager.eventID,eventName:e,eventComment:n,eventType:t},function(a){var r=new Promise(function(a,r){IntelDCC.eventManager.eventID?a():$.post("api/get-events.php",function(r){var s=r.filter(function(a){return a.eventName.trim()==e&&a.eventComment.trim()==n&&a.eventType==t});1===s.length&&(IntelDCC.api.event=s[0],IntelDCC.api.event.alerts=[],IntelDCC.api.event.users=[],IntelDCC.eventManager.eventID=IntelDCC.api.event.id,a())})});r.then(function(){IntelDCC.eventManager.saveEventDeletions()})})},IntelDCC.eventManager.saveEventDeletions=function(){var e=[];IntelDCC.eventManager.alertsUpdated&&IntelDCC.api.event.alerts.forEach(function(n){e.push(new Promise(function(e,t){$.post("api/delete-event-alert.php",{eventID:IntelDCC.eventManager.eventID,groupID:n.groupId,deviceID:n.deviceId,sensorID:n.sensorId,alertLevel:n.alertLevel},function(n){e()})}))}),IntelDCC.eventManager.usersUpdated&&IntelDCC.api.event.users.forEach(function(n){e.push(new Promise(function(e,t){$.post("api/delete-event-user.php",{eventID:IntelDCC.eventManager.eventID,userID:n.userId},function(n){e()})}))}),Promise.all(e).then(function(e){IntelDCC.eventManager.saveEventInsertions()})},IntelDCC.eventManager.saveEventInsertions=function(){var e=[];IntelDCC.eventManager.alertsUpdated&&$("#alerts-list").find("[data-event-alert]").each(function(n,t){var a=$(t).attr("data-group-id"),r=$(t).attr("data-device-id"),s=$(t).attr("data-sensor-id"),o=$(t).attr("data-alert-level");e.push(new Promise(function(e,n){$.post("api/set-event-alert.php",{eventID:IntelDCC.eventManager.eventID,groupID:a,deviceID:r,sensorID:s,alertLevel:o},function(n){e()})}))}),IntelDCC.eventManager.usersUpdated&&$("#user-list").find("[data-event-user]").each(function(n,t){var a=$(t).attr("data-user-id");e.push(new Promise(function(e,n){$.post("api/set-event-user.php",{eventID:IntelDCC.eventManager.eventID,userID:a},function(n){e()})}))}),Promise.all(e).then(function(e){IntelDCC.eventManager.saveEventFinish()})},IntelDCC.eventManager.saveEventFinish=function(){IntelDCC.scrollTo(0),$("#intel-api-loading-icon").hide();var e=$("#page-notification");e.addClass("page-notification--show"),setTimeout(function(){$("#save-event-button").removeAttr("disabled"),e.removeClass("page-notification--show")},4e3)}}();