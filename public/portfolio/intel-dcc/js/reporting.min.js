!function(){"use strict";IntelDCC.api={},IntelDCC.api.devices=[],IntelDCC.reporting={groupID:null,deviceID:null,sensorData:[]},IntelDCC.reporting.refresh={delay:1500,timeout:null},$(document).ready(function(){IntelDCC.reporting.initialReportParams(),IntelDCC.reporting.eventListeners(),IntelDCC.reporting.downloadData()}),IntelDCC.reporting.initialReportParams=function(){var e=IntelDCC.getParameterByName("period"),t=IntelDCC.getParameterByName("interval");$('[data-period-filter="default"]').prop("checked",!0),$('[data-interval-filter="default"]').prop("checked",!0),e&&t&&($("[data-period-filter]").each(function(){this.value===e&&$(this).prop("checked",!0)}),$("[data-interval-filter]").each(function(){this.value===t&&$(this).prop("checked",!0)}))},IntelDCC.reporting.eventListeners=function(){$("#reporting-site-list").on("change","[data-primary-checkbox]",function(){IntelDCC.reporting.deviceCheckboxChanged(this)}),$("#reporting-site-list").on("change","[data-secondary-checkbox]",function(){IntelDCC.reporting.sensorCheckboxChanged(this)}),$("[data-period-filter]").on("change",function(){IntelDCC.reporting.changePeriodFilterOption(this)}),$("#custom-from-date, #custom-to-date").on("input",function(){IntelDCC.reporting.customPeriodUpdated()}),$("[data-interval-filter]").on("change",function(){IntelDCC.reporting.updateIntervalFilter(this)}),$("[data-page-content-tabs]").on("click","[data-page-content-tab]",function(){IntelDCC.reporting.switchPageContentTab(this)}),$("#export-excel-form").on("submit",function(){return IntelDCC.reporting.exportExcel()})},IntelDCC.reporting.downloadData=function(){$("#intel-api-loading-icon").show(),$.post("api/get-devices.php",function(e){IntelDCC.api.devices=e,IntelDCC.reporting.generateDeviceList(),$("#intel-api-loading-icon").hide()})},IntelDCC.reporting.generateDeviceList=function(){var e=document.getElementById("reporting-site-list");e.innerHTML="",IntelDCC.api.devices.forEach(function(t){var a="",n=t.data.sensorList.split(", ");a+='<div class="page-content__outlet">',a+='<div class="device-listing" data-device-listing data-group-id="'+t.group.groupId+'" data-device-id="'+t.data.deviceId+'" data-display-name="'+t.data.displayName+'">',a+='<div class="device-listing__header">',a+='<label class="device-listing__table">',a+='<div class="device-listing__table__left">',a+='<p class="device-listing__title">'+t.data.displayName+"</p>",a+="</div>",a+='<div class="device-listing__table__right">',a+='<span class="fancy-checkbox fancy-checkbox--standalone">',a+='<input class="fancy-checkbox__input" type="checkbox" data-primary-checkbox>',a+='<span class="fancy-checkbox__icon"></span>',a+="</span>",a+="</div>",a+="</label>",a+="</div>",a+='<div class="device-listing__footer">',n.forEach(function(e){a+='<label class="device-listing__table">',a+='<div class="device-listing__table__left">',a+='<p class="device-listing__description">'+e+"</p>",a+="</div>",a+='<div class="device-listing__table__right">',a+='<span class="fancy-checkbox fancy-checkbox--standalone">',a+='<input class="fancy-checkbox__input" type="checkbox" data-secondary-checkbox data-sensor-id="'+e+'">',a+='<span class="fancy-checkbox__icon"></span>',a+="</span>",a+="</div>",a+="</label>"}),a+="</div>",a+="</div>",a+="</div>",e.innerHTML+=a}),IntelDCC.reporting.remainingReportParams()},IntelDCC.reporting.remainingReportParams=function(){var e=document.getElementById("reporting-site-list");IntelDCC.reporting.groupID=IntelDCC.getParameterByName("group-id"),IntelDCC.reporting.deviceID=IntelDCC.getParameterByName("device-id"),IntelDCC.reporting.groupID&&IntelDCC.reporting.deviceID&&$("[data-device-listing]").each(function(){var t=$(this).attr("data-group-id"),a=$(this).attr("data-device-id");IntelDCC.reporting.groupID===t&&IntelDCC.reporting.deviceID===a&&($(this).find("[data-primary-checkbox]").trigger("click"),$(this).closest(".page-content__outlet").prependTo(e))})},IntelDCC.reporting.deviceCheckboxChanged=function(e){var t=$(e).prop("checked"),a=$(e).closest("[data-device-listing]");$(a).find("[data-secondary-checkbox]").prop("checked",t),IntelDCC.reporting.downloadSensorData()},IntelDCC.reporting.sensorCheckboxChanged=function(e){var t=!0,a=$(e).closest("[data-device-listing]");$(a).find("[data-secondary-checkbox]").each(function(){$(this).prop("checked")===!1&&(t=!1)}),$(a).find("[data-primary-checkbox]").prop("checked",t),IntelDCC.reporting.downloadSensorData()},IntelDCC.reporting.changePeriodFilterOption=function(e){var t=$("[data-period-filter-footer]");t.toggleClass("period-filter__footer--visible","custom"===$(e).val()),IntelDCC.reporting.downloadSensorData()},IntelDCC.reporting.customPeriodUpdated=function(){var e=$("#custom-from-date"),t=$("#custom-to-date"),a=e.val().trim().length>0,n=t.val().trim().length>0;e.toggleClass("standard-input--validate",a),t.toggleClass("standard-input--validate",n),IntelDCC.reporting.downloadSensorData()},IntelDCC.reporting.updateIntervalFilter=function(e){IntelDCC.reporting.downloadSensorData()},IntelDCC.reporting.switchPageContentTab=function(e){var t=$(e).closest("[data-page-content-tabs]"),a=$(t).find("[data-page-content-tab]");a.removeClass("page-content-tabs__tab--active"),$(e).addClass("page-content-tabs__tab--active"),a.each(function(){var e=$(this).attr("data-target-id");document.getElementById(e).classList.add("hidden")});var n=$(e).attr("data-target-id");document.getElementById(n).classList.remove("hidden")},IntelDCC.reporting.getSensorList=function(){var e=[];return $("[data-secondary-checkbox]:checked").each(function(){var t=$(this).attr("data-sensor-id"),a=$(this).closest("[data-device-listing]"),n=$(a).attr("data-group-id"),i=$(a).attr("data-device-id"),r=$(a).attr("data-display-name");e.push({sensorID:t,groupID:n,deviceID:i,displayName:r})}),e},IntelDCC.reporting.getCustomTimestamps=function(){var e={valid:!1,from:null,to:null},t=$("#custom-from-date"),a=$("#custom-to-date");if(t.is(":valid")&&a.is(":valid")){var n=moment(t.val(),"DD-MM-YYYY"),i=moment(a.val(),"DD-MM-YYYY"),r=moment().format("X");e.from=n.format("X"),e.to=i.format("X"),e.to>r&&(e.to=r),e.from<e.to&&(e.valid=!0)}return e},IntelDCC.reporting.downloadSensorData=function(){clearTimeout(IntelDCC.reporting.refresh.timeout);var e=$("[data-period-filter]:checked").val(),t=IntelDCC.reporting.getCustomTimestamps();return("custom"!==e||t.valid!==!1)&&void(IntelDCC.reporting.refresh.timeout=setTimeout(function(){$("#data-content-area").empty(),$("#graph-content-area").empty(),$("#export-excel-data").val(""),IntelDCC.reporting.sensorData=[];var a=$("[data-page-content-tab]").first();IntelDCC.reporting.switchPageContentTab(a);var n=IntelDCC.reporting.getSensorList();n.forEach(function(a){var n="raw",i=IntelDCC.getSensorType(a.sensorID);"RAINFALL"===i?n=$("#rain-interval-filters input:checked").val():"RIVER_LEVEL"===i&&(n=$("#river-interval-filters input:checked").val()),IntelDCC.charts.downloadSensorData(a.groupID,a.deviceID,a.sensorID,e,n,t.from,t.to).then(function(e){return IntelDCC.reporting.generateChart(a.displayName,e),IntelDCC.reporting.generateTable(a.displayName,e),e}).then(function(e){var t=document.getElementById("graph-content-area"),n=$(t).find("canvas").last().get(0);e.device=a.displayName,e.chartDataURL=n.toDataURL(),IntelDCC.reporting.sensorData.push(e)})})},IntelDCC.reporting.refresh.delay))},IntelDCC.reporting.generateChart=function(e,t){var a=document.getElementById("graph-content-area"),n=document.createElement("div");n.className="reporting-chart";var i="";i+='<div class="reporting-chart__header">',i+="<p>"+e+"</p>",i+="<p>"+t.sensorID+"</p>",i+="</div>",i+='<div class="responsive-chart" data-responsive-chart>',i+='<h3 class="responsive-chart__title" data-chart-title>&nbsp;</h3>',i+='<div class="responsive-chart__container">',i+='<canvas class="responsive-chart__canvas"></canvas>',i+="</div>",i+="</div>",n.innerHTML=i,a.appendChild(n);var r=$(a).find("canvas").last().get(0);IntelDCC.charts.drawChart(t,r)},IntelDCC.reporting.generateTable=function(e,t){var a=document.getElementById("data-content-area"),n=document.createElement("div");n.className="reporting-chart";var i="";i+='<div class="reporting-chart__header">',i+="<p>"+e+"</p>",i+="<p>"+t.sensorID+"</p>",i+="</div>",i+='<h3 class="responsive-chart__title">'+t.description+"</h3>",i+="<br>",i+='<div class="standard-table standard-table--collapse-margin">',t.data.forEach(function(e){i+='<div class="standard-table__row">',i+='<div class="standard-table__cell"><p>'+moment.unix(e.date).format("DD/MM/YYYY - HH:mm")+"</p></div>",i+='<div class="standard-table__cell"><p><strong>'+e.value+'</strong> <span style="color: #1CBCD2">'+t.unit+"</span></p></div>",i+="</div>"}),i+="</div>",n.innerHTML=i,a.appendChild(n)},IntelDCC.reporting.exportExcel=function(){if(0===IntelDCC.reporting.sensorData.length)return $("#export-excel-form").animateCSS("form-error"),!1;var e=JSON.stringify(IntelDCC.reporting.sensorData);$("#export-excel-data").val(e)}}();